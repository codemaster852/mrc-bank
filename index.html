<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRC Bank</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card-base {
            background: linear-gradient(135deg, #6B7280 0%, #1F2937 100%);
        }
        .card-platinum {
             background: linear-gradient(135deg, #e5e7eb 0%, #9ca3af 100%);
        }
        .card-vip {
            background: linear-gradient(135deg, #fde047 0%, #b45309 100%);
        }
        .card-unlimited {
            background: linear-gradient(135deg, #1f2937 0%, #000000 100%);
        }

        /* Card Flip Animation */
        .card-container {
            perspective: 1000px;
            width: 100%;
            height: 220px; /* Fixed height for the card */
        }
        .card-flipper {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }
        /* New class to control the flip */
        .card-flipper.is-flipped {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari */
            backface-visibility: hidden;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .card-back {
            transform: rotateY(180deg);
            align-items: center;
        }
        .card-back .cvv-strip {
            width: 100%;
            height: 50px;
            background: #374151;
            margin-top: 1.5rem;
        }
        .card-back .cvv-box {
            background: white;
            color: #111827;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            text-align: right;
            width: 80%;
            font-style: italic;
            font-family: monospace;
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto p-4">

        <!-- Header -->
        <header class="flex justify-between items-center py-4">
            <h1 class="text-3xl font-bold text-gray-900">MRC Bank</h1>
            <div id="user-menu"></div>
        </header>

        <main id="content" class="mt-8">
            <!-- App content will be rendered here -->
        </main>

    </div>

    <script type="module">
        // --- SUPABASE CLIENT SETUP ---
        const supabaseUrl = 'https://effpdesipfziszvborof.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVmZnBkZXNpcGZ6aXN6dmJvcm9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTQzOTgsImV4cCI6MjA2OTAzMDM5OH0.JIgvjeBI_N_TpJRWc1ptKpr4CoXbAfT8huvNfRA1nqY';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // --- DOM ELEMENTS ---
        const app = document.getElementById('app');
        const content = document.getElementById('content');
        const userMenu = document.getElementById('user-menu');

        // --- STATE ---
        let currentUser = null;
        let userProfile = null;

        // --- ROUTING ---
        function navigate(path) {
            window.location.hash = path;
            router();
        }

        async function router() {
            const path = window.location.hash.slice(1) || '/';
            content.innerHTML = '<div class="text-center p-8"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-gray-900 mx-auto"></div><p class="mt-4">Loading...</p></div>';

            const session = await supabaseClient.auth.getSession();
            currentUser = session?.data?.session?.user || null;

            if (currentUser) {
                await fetchUserProfile();
            }
            
            updateUserMenu();

            if (path.startsWith('/admin')) {
                renderAdmin(path);
            } else if (currentUser) {
                switch (path) {
                    case '/dashboard':
                        renderDashboard();
                        break;
                    case '/transfer':
                        renderTransfer();
                        break;
                    default:
                        navigate('/dashboard');
                }
            } else {
                switch (path) {
                    case '/login':
                        renderLogin();
                        break;
                    case '/signup':
                        renderSignup();
                        break;
                    default:
                        renderHomepage();
                }
            }
        }

        // --- UI RENDERING ---

        function updateUserMenu() {
            if (currentUser) {
                userMenu.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <span class="font-semibold">${userProfile?.username || ''}</span>
                        <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</button>
                        ${userProfile?.is_admin ? '<button id="admin-panel-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Admin Panel</button>' : ''}
                    </div>
                `;
                document.getElementById('logout-button').addEventListener('click', handleLogout);
                if(userProfile?.is_admin) {
                   document.getElementById('admin-panel-button').addEventListener('click', () => navigate('/admin'));
                }
            } else {
                userMenu.innerHTML = `
                    <div class="space-x-2">
                        <button onclick="navigate('/login')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Login</button>
                        <button onclick="navigate('/signup')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Sign Up</button>
                    </div>
                `;
            }
        }

        function renderHomepage() {
            content.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                    <h2 class="text-4xl font-bold mb-4">Welcome to MRC Bank</h2>
                    <p class="text-gray-600 mb-8">Your virtual bank for seamless payments in MRC Services with MP points.</p>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div class="bg-gray-50 p-6 rounded-lg flex flex-col justify-between">
                            <div>
                                <h3 class="text-2xl font-semibold mb-2">Our Services</h3>
                                <p>Instantly transfer MP to other users, manage your virtual card, and track your spending. All in one place.</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg flex flex-col justify-between">
                            <div>
                                <h3 class="text-2xl font-semibold mb-2">Get Started</h3>
                                <p>Create an account today to receive your virtual card and 100 MP to start your journey.</p>
                            </div>
                            <button onclick="navigate('/signup')" class="mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Sign Up Now</button>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg flex flex-col justify-between">
                            <div>
                                <h3 class="text-2xl font-semibold mb-2">Admin Panel</h3>
                                <p>Admins can log in here to manage users, update balances, and oversee the platform.</p>
                            </div>
                             <button onclick="navigate('/login')" class="mt-4 bg-gray-800 hover:bg-gray-900 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Admin Login</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLogin() {
            content.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-6">Login</h2>
                    <form id="login-form">
                        <div class="mb-4">
                            <label for="email" class="block text-gray-700 font-semibold mb-2">Email</label>
                            <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-gray-700 font-semibold mb-2">Password</label>
                            <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Login</button>
                    </form>
                    <p id="login-error" class="text-red-500 text-center mt-4"></p>
                    <p class="text-center mt-4">Don't have an account? <a href="#" onclick="navigate('/signup')" class="text-blue-500 hover:underline">Sign up</a></p>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        function renderSignup() {
            content.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-6">Create Your Account</h2>
                    <form id="signup-form">
                        <div class="mb-4">
                            <label for="username" class="block text-gray-700 font-semibold mb-2">Username</label>
                            <p class="text-sm text-gray-500 mb-2">This will be shown on your card, so please write your real name.</p>
                            <input type="text" id="username" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <div class="mb-4">
                            <label for="email" class="block text-gray-700 font-semibold mb-2">Email</label>
                            <input type="email" id="email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-gray-700 font-semibold mb-2">Password</label>
                            <input type="password" id="password" minlength="8" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" required>
                        </div>

                        <div class="mb-6 bg-gray-50 p-4 rounded-lg border">
                            <h4 class="font-semibold text-gray-800 mb-2">Terms and Policies</h4>
                            <ul class="list-disc list-inside text-sm text-gray-600 space-y-1">
                                <li>If you write false data, your account will be banned.</li>
                                <li>If you transfer money from your other accounts to your main account, all your accounts will get banned.</li>
                            </ul>
                            <div class="mt-4 flex items-center">
                                <input type="checkbox" id="terms" class="h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                                <label for="terms" class="ml-2 block text-sm text-gray-900">I have read and agree to the terms and policies.</label>
                            </div>
                        </div>

                        <button type="submit" id="signup-button" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 disabled:bg-gray-400" disabled>Sign Up</button>
                    </form>
                    <p id="signup-error" class="text-red-500 text-center mt-4"></p>
                    <p class="text-center mt-4">Already have an account? <a href="#" onclick="navigate('/login')" class="text-blue-500 hover:underline">Login</a></p>
                </div>
            `;
            document.getElementById('signup-form').addEventListener('submit', handleSignup);
            document.getElementById('terms').addEventListener('change', (e) => {
                document.getElementById('signup-button').disabled = !e.target.checked;
            });
        }

        function renderDashboard() {
            if (!userProfile) {
                content.innerHTML = '<p>Loading profile...</p>';
                return;
            }
            const cardClass = `card-${userProfile.card_type?.toLowerCase() || 'platinum'}`;
            content.innerHTML = `
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- Virtual Card -->
                    <div class="relative">
                        <div class="card-container">
                            <div id="card-flipper" class="card-flipper">
                                <!-- Card Front -->
                                <div class="card-face ${cardClass} text-white">
                                    <div>
                                        <div class="flex justify-between items-center">
                                            <h3 class="text-lg font-semibold">MRC Virtual Card</h3>
                                            <span class="font-bold uppercase text-sm px-2 py-1 bg-white/20 rounded-md">${userProfile.card_type || 'Platinum'}</span>
                                        </div>
                                        <div class="mt-8 text-2xl font-mono tracking-widest">${formatCardNumber(userProfile.card_number)}</div>
                                    </div>
                                    <div class="flex justify-between items-end mt-4">
                                        <div>
                                            <p class="text-xs text-gray-200">Card Holder</p>
                                            <p class="font-medium">${userProfile.username}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs text-gray-200">Expires</p>
                                            <p class="font-medium">--/--</p>
                                        </div>
                                    </div>
                                </div>
                                <!-- Card Back -->
                                <div class="card-face card-back ${cardClass} text-white">
                                    <div class="w-full h-full flex flex-col justify-center items-center">
                                        <div class="cvv-strip"></div>
                                        <div class="cvv-box mt-4">
                                            <span>${userProfile.cvv}</span>
                                        </div>
                                        <p class="text-xs mt-2 text-gray-300">CVV</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button id="card-flip-btn" class="absolute top-0 right-0 -mt-2 -mr-2 bg-white p-2 rounded-full shadow-lg text-gray-600 hover:text-gray-900 transition">
                            <!-- SVG icon will be injected here -->
                        </button>
                    </div>

                    <!-- Balance and Actions -->
                    <div class="bg-white p-8 rounded-xl shadow-lg">
                        <h3 class="text-2xl font-bold mb-2">Your Balance</h3>
                        <p class="text-5xl font-bold text-blue-600">${userProfile.card_type === 'Unlimited' ? '∞' : userProfile.balance.toFixed(2)} <span class="text-3xl text-gray-500">MP</span></p>
                        <div class="mt-8">
                            <button onclick="navigate('/transfer')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Transfer MP</button>
                        </div>
                    </div>
                </div>
            `;
            setupCardInteraction();
        }
        
        function renderTransfer() {
            content.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
                    <h2 class="text-3xl font-bold text-center mb-6">Transfer MP</h2>
                    <form id="transfer-form">
                        <div class="mb-4">
                            <label for="recipient-card" class="block text-gray-700 font-semibold mb-2">Recipient's Card Number</label>
                            <input type="text" id="recipient-card" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="XXXX XXXX XXXX XXXX">
                        </div>
                        <div class="mb-6">
                            <label for="amount" class="block text-gray-700 font-semibold mb-2">Amount (MP)</label>
                            <input type="number" id="amount" min="0.01" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Send Money</button>
                    </form>
                    <div id="transfer-message" class="text-center mt-4"></div>
                    <p class="text-center mt-4"><a href="#" onclick="navigate('/dashboard')" class="text-blue-500 hover:underline">Back to Dashboard</a></p>
                </div>
            `;
            document.getElementById('transfer-form').addEventListener('submit', handleTransfer);
        }
        
        async function renderAdmin(path) {
            if (!userProfile?.is_admin) {
                content.innerHTML = `<p class="text-red-500 text-center">Access Denied. You are not an admin.</p>`;
                return;
            }

            if (path === '/admin') {
                 renderAdminDashboard();
            } else if (path.startsWith('/admin/user/')) {
                const userId = path.split('/')[3];
                renderAdminEditUser(userId);
            }
        }
        
        async function renderAdminDashboard() {
            const { data: users, error } = await supabaseClient.from('profiles').select('*');
            if (error) {
                content.innerHTML = `<p class="text-red-500">Error fetching users: ${error.message}</p>`;
                return;
            }

            content.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg">
                    <h2 class="text-3xl font-bold mb-6">Admin Panel - Users</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-800 text-white">
                                <tr>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Username</th>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Card Type</th>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Balance</th>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Status</th>
                                    <th class="text-left py-3 px-4 uppercase font-semibold text-sm">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="text-gray-700">
                                ${users.map(user => `
                                    <tr class="border-b">
                                        <td class="py-3 px-4">${user.username}</td>
                                        <td class="py-3 px-4 font-semibold">${user.card_type}</td>
                                        <td class="py-3 px-4">${user.card_type === 'Unlimited' ? '∞' : user.balance.toFixed(2)} MP</td>
                                        <td class="py-3 px-4">${user.is_banned ? '<span class="text-red-500 font-semibold">Banned</span>' : '<span class="text-green-500 font-semibold">Active</span>'}</td>
                                        <td class="py-3 px-4">
                                            <button onclick="navigate('/admin/user/${user.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-bold py-1 px-2 rounded">Edit</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function renderAdminEditUser(userId) {
            const { data: user, error } = await supabaseClient.from('profiles').select('*').eq('id', userId).single();
            if (error || !user) {
                content.innerHTML = `<p class="text-red-500">Error fetching user data.</p>`;
                return;
            }

            content.innerHTML = `
                <div class="bg-white p-8 rounded-xl shadow-lg max-w-lg mx-auto">
                    <h2 class="text-3xl font-bold mb-6">Edit User: ${user.username}</h2>
                    <form id="admin-edit-form">
                         <div class="mb-4">
                            <label for="balance" class="block text-gray-700 font-semibold mb-2">Balance (MP)</label>
                            <input type="number" id="balance" step="1" class="w-full px-4 py-2 border rounded-lg" value="${user.balance}">
                        </div>
                        <div class="mb-6">
                            <label for="card-type" class="block text-gray-700 font-semibold mb-2">Card Type</label>
                            <select id="card-type" class="w-full px-4 py-2 border rounded-lg bg-white">
                                <option value="Platinum" ${user.card_type === 'Platinum' ? 'selected' : ''}>Platinum</option>
                                <option value="VIP" ${user.card_type === 'VIP' ? 'selected' : ''}>VIP</option>
                                <option value="Unlimited" ${user.card_type === 'Unlimited' ? 'selected' : ''}>Unlimited</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg mb-4">Update User</button>
                    </form>
                    <div id="admin-message" class="text-center my-4"></div>
                     <button id="ban-button" class="w-full ${user.is_banned ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'} text-white font-bold py-2 px-4 rounded-lg">
                        ${user.is_banned ? 'Unban User' : 'Ban User'}
                    </button>
                    <p class="text-center mt-6"><a href="#" onclick="navigate('/admin')" class="text-blue-500 hover:underline">Back to Admin Dashboard</a></p>
                </div>
            `;
            document.getElementById('admin-edit-form').addEventListener('submit', (e) => handleAdminUpdateUser(e, userId));
            document.getElementById('ban-button').addEventListener('click', () => handleAdminToggleBan(userId, user.is_banned));
        }


        // --- EVENT HANDLERS & LOGIC ---

        async function handleSignup(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('signup-error');
            errorEl.textContent = '';

            const isAdmin = (email.toLowerCase() === 'mostafaalatawy@gmail.com');

            const { data: { user }, error } = await supabaseClient.auth.signUp({ email, password });

            if (error) {
                errorEl.textContent = error.message;
                return;
            }
            if (user) {
                await createProfile(user.id, username, isAdmin);
                const message = isAdmin 
                    ? 'Admin account created successfully! Please verify your email.'
                    : 'Signup successful! Please check your email to verify your account.';
                alert(message);
                navigate('/login');
            }
        }

        async function createProfile(userId, username, isAdmin = false) {
            const cardNumber = Array.from({ length: 16 }, () => Math.floor(Math.random() * 10)).join('');
            const cvv = Array.from({ length: 3 }, () => Math.floor(Math.random() * 10)).join('');

            const { error } = await supabaseClient.from('profiles').insert({
                id: userId,
                username: username,
                card_number: cardNumber,
                cvv: cvv,
                balance: 100.00,
                initial_balance_spent: false,
                is_admin: isAdmin,
                is_banned: false,
                card_type: isAdmin ? 'Unlimited' : 'Platinum'
            });

            if (error) {
                console.error('Error creating profile:', error);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';

            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                errorEl.textContent = error.message;
            } else {
                router();
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            userProfile = null;
            navigate('/');
        }
        
        async function handleTransfer(e) {
            e.preventDefault();
            const recipientCard = document.getElementById('recipient-card').value.replace(/\s/g, '');
            const amount = parseFloat(document.getElementById('amount').value);
            const messageEl = document.getElementById('transfer-message');
            messageEl.textContent = '';

            if (isNaN(amount) || amount <= 0) {
                messageEl.textContent = 'Invalid amount.';
                messageEl.className = 'text-red-500 text-center mt-4';
                return;
            }
            
            if (userProfile.card_type !== 'Unlimited' && userProfile.balance <= 100 && !userProfile.initial_balance_spent) {
                 messageEl.textContent = 'You cannot transfer your initial 100 MP bonus.';
                 messageEl.className = 'text-red-500 text-center mt-4';
                 return;
            }

            if (userProfile.card_type !== 'Unlimited' && userProfile.balance < amount) {
                messageEl.textContent = 'Insufficient funds.';
                messageEl.className = 'text-red-500 text-center mt-4';
                return;
            }

            const { data: recipient, error: recipientError } = await supabaseClient
                .from('profiles')
                .select('id, balance')
                .eq('card_number', recipientCard)
                .single();

            if (recipientError || !recipient) {
                messageEl.textContent = 'Recipient card number not found.';
                messageEl.className = 'text-red-500 text-center mt-4';
                return;
            }
            
            if (recipient.id === userProfile.id) {
                messageEl.textContent = 'You cannot transfer money to yourself.';
                messageEl.className = 'text-red-500 text-center mt-4';
                return;
            }
            
            const newRecipientBalance = recipient.balance + amount;
            let senderUpdate = { initial_balance_spent: true };
            
            if (userProfile.card_type !== 'Unlimited') {
                senderUpdate.balance = userProfile.balance - amount;
            }

            const { error: senderError } = await supabaseClient
                .from('profiles')
                .update(senderUpdate)
                .eq('id', userProfile.id);

            const { error: recipientUpdateError } = await supabaseClient
                .from('profiles')
                .update({ balance: newRecipientBalance })
                .eq('id', recipient.id);

            if (senderError || recipientUpdateError) {
                messageEl.textContent = 'Transaction failed. Please try again.';
                messageEl.className = 'text-red-500 text-center mt-4';
            } else {
                messageEl.textContent = `Successfully transferred ${amount.toFixed(2)} MP!`;
                messageEl.className = 'text-green-500 text-center mt-4';
                document.getElementById('transfer-form').reset();
                await fetchUserProfile();
            }
        }
        
        async function handleAdminUpdateUser(e, userId) {
            e.preventDefault();
            const newBalance = parseFloat(document.getElementById('balance').value);
            const cardType = document.getElementById('card-type').value;
            const messageEl = document.getElementById('admin-message');
            
            if (isNaN(newBalance) || newBalance < 0) {
                 messageEl.textContent = 'Invalid balance amount.';
                 messageEl.className = 'text-red-500 text-center my-4';
                 return;
            }
            
            const { error } = await supabaseClient.from('profiles').update({ balance: newBalance, card_type: cardType }).eq('id', userId);
            
            if (error) {
                messageEl.textContent = `Error: ${error.message}`;
                messageEl.className = 'text-red-500 text-center my-4';
            } else {
                messageEl.textContent = 'User updated successfully!';
                messageEl.className = 'text-green-500 text-center my-4';
            }
        }

        async function handleAdminToggleBan(userId, isCurrentlyBanned) {
            const messageEl = document.getElementById('admin-message');
            const { error } = await supabaseClient.from('profiles').update({ is_banned: !isCurrentlyBanned }).eq('id', userId);

            if (error) {
                messageEl.textContent = `Error: ${error.message}`;
                messageEl.className = 'text-red-500 text-center my-4';
            } else {
                messageEl.textContent = `User has been ${!isCurrentlyBanned ? 'banned' : 'unbanned'}.`;
                messageEl.className = 'text-green-500 text-center my-4';
                renderAdminEditUser(userId);
            }
        }


        // --- HELPER FUNCTIONS ---

        async function fetchUserProfile() {
            if (!currentUser) return;
            const { data, error } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();

            if (error) {
                console.error('Error fetching profile:', error);
                if (error.code === 'PGRST116') { // This code means "0 rows returned"
                    console.log('User exists in auth, but not in profiles. Signing out.');
                    await supabaseClient.auth.signOut();
                    navigate('/login');
                }
            } else {
                userProfile = data;
                if (userProfile.is_banned) {
                    alert('Your account has been banned.');
                    await supabaseClient.auth.signOut();
                    navigate('/');
                }
            }
        }

        function formatCardNumber(num) {
            if (!num) return 'XXXX XXXX XXXX XXXX';
            return num.match(/.{1,4}/g).join(' ');
        }
        
        function setupCardInteraction() {
            const cardFlipper = document.getElementById('card-flipper');
            const flipButton = document.getElementById('card-flip-btn');
            if (!cardFlipper || !flipButton) return;

            const showIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
            const hideIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>`;

            let isFlipped = false;
            
            function updateCardState() {
                if (isFlipped) {
                    cardFlipper.classList.add('is-flipped');
                    flipButton.innerHTML = showIcon;
                } else {
                    cardFlipper.classList.remove('is-flipped');
                    flipButton.innerHTML = hideIcon;
                }
            }
            
            flipButton.addEventListener('click', () => {
                isFlipped = !isFlipped;
                updateCardState();
            });

            updateCardState(); // Set initial state
        }
        
        // --- INITIALIZATION ---
        window.addEventListener('hashchange', router);
        window.addEventListener('load', router);
        window.navigate = navigate;

    </script>
</body>
</html>
